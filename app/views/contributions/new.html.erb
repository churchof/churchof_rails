

<% content_for :head do %>

<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

  <script type="text/javascript">

    jQuery(function($) { Stripe.setPublishableKey($('meta[name="stripe-key"]').attr('content'));})

      var stripeResponseHandler = function(status, response) {


        var $form = $('#new_contribution');
        if (response.error) {

              alert("string response - error");

          $form.find('.payment-errors').text(response.error.message);
          $form.find('button').prop('disabled', false);


        } else {

          var token = response.id;
          var currency = response.currency || 'USD';
          $form.append($('<input type="hidden" name="contribution[stripe_token]" />').val(token));
          $form.append($('<input type="hidden" name="contribution[stripe_currency]" />').val(currency));



          // and re-submit
          $form.get(0).submit();
        }
      };

      jQuery(function($) {
        $('#new_contribution').submit(function(e) {
          var $form = $(this);
          $form.find('button').prop('disabled', true);
          Stripe.createToken($form, stripeResponseHandler);
          return false;
        });
      });
  </script>

<% end %>


<%= simple_form_for [@need, @contribution] do |f| %>
  <span class="payment-errors"></span>

  <div class="form-row">
    <label>
      <span>Card Number</span>
      <input type="text" size="20" data-stripe="number"/>
    </label>
  </div>

  <div class="form-row">
    <label>
      <span>CVC</span>
      <input type="text" size="4" data-stripe="cvc"/>
    </label>
  </div>

  <div class="form-row">
    <label>
      <span>Expiration (MM/YYYY)</span>
      <input type="text" size="2" data-stripe="exp-month"/>
    </label>
    <span> / </span>
    <input type="text" size="4" data-stripe="exp-year"/>
  </div>

  <div class="form-row">
    <label>
      <span>Amount</span>
      <%= f.input :amount %>
    </label>
  </div>

  <% if !user_signed_in? %>
    <div class="form-row">
      <label>
        <span>Email this should only show if the user is not logged in </span>
        <%= f.text_field :email, :required => true %>
      </label>
    </div>
  <% else %>
      <%= f.input :email, :as => :hidden, :input_html => { :value => current_user.email } %>

  <% end %>

      <%= link_to "By Submitting you agree to the TERMS AND CONDITIONS", contribution_terms_path %>

  <button type="submit">Submit Payment</button>
<% end %>
