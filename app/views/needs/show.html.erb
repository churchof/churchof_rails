
<% content_for :head do %>
  <script type="text/javascript">
    jQuery(function($) {
      $('#rosmModal').on('show.bs.modal', function() {
          // logger.debug "FUN"
          //alert('hi');
          // $.post('/logs', {message: 'Your log message'})

          <% if current_user.is_full_rosm_member %>
            <% Activity.create( subject: @need, description: 'User viewed ROSM records. Paid Member at time? YES', user: current_user ) %>
          <% else %>
            <% Activity.create( subject: @need, description: 'User viewed ROSM records. Paid Member at time? NO', user: current_user ) %>
          <% end %>

      });
    });
  </script>
<% end %>

  <!-- The required Stripe lib -->
  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
 
  <!-- jQuery is used only for this example; it isn't required to use Stripe -->
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>


  <script type="text/javascript">

    // This identifies your website in the createToken call below
    Stripe.setPublishableKey('pk_test_EvYspVJmIJvMohKKhAykkgwA');
 
    var stripeResponseHandler = function(status, response) {
      var $form = $('#payment-form');
 
      if (response.error) {
        // Show the errors on the form
        $form.find('.payment-errors').text(response.error.message);
        $form.find('button').prop('disabled', false);
      } else {
        // token contains id, last4, and card type
        var token = response.id;
        var currency = response.currency;
        // Insert the token into the form so it gets submitted to the server
        $form.append($('<input type="hidden" name="stripeToken" />').val(token));
        $form.append($('<input type="hidden" name="stripeCurrency" />').val(currency));
        // and re-submit
        $form.get(0).submit();
      }
    };
 
    jQuery(function($) {
      $('#payment-form').submit(function(e) {
        var $form = $(this);
 
        // Disable the submit button to prevent repeated clicks
        $form.find('button').prop('disabled', true);
 
        Stripe.createToken($form, stripeResponseHandler);
 
        // Prevent the form from submitting with the default action
        return false;
      });
    });


  </script>



<div class="page-header-block">
</div>

<div class="needs main-content">
  <div class="need-container">
    <div class="inner-content">

      <h2 class="need-title">
        <% if current_user == @need.user_posted_by || current_user == @need.user_church_admin %>
          <%= @need.title %>
        <% else %>
          <%= @need.title_public %>
        <% end %>
      </h2>

      <div class="need-description">
        <% if current_user == @need.user_posted_by || current_user == @need.user_church_admin %>
          <p><%= @need.description %></p>
        <% else %>
          <p><%= @need.description_public %></p>
        <% end %>
      </div>
      <% if current_user == @need.user_posted_by || current_user == @need.user_church_admin %>
        <div class="private-information">
          <% if @need.first_name? %>
            <p class="first-name">
              <strong>First Name: </strong>
              <%= @need.first_name %>
            </p>
          <% end %>

          <% if @need.last_name? %>
            <p class="last-name">
              <strong>Last Name: </strong>
              <%= @need.last_name %>
            </p>
          <% end %>

          <% if @need.last_four_ssn? %>
            <p class="social-security-number">
              <strong>Last 4 SSN: </strong>
              <%= @need.last_four_ssn %>
            </p>
          <% end %>

          <% if @need.street_address? %>
            <p class="street-address">
              <strong>Street Address: </strong>
              <%= @need.street_address %>
            </p>
          <% end %>

          <% if @need.drivers_license? %>
            <p class="drivers-license">
              <strong>Driver's License: </strong>
              <%= @need.drivers_license %>
            </p>
          <% end %>

          <% if @need.age? %>
            <p class="age">
              <strong>Age: </strong>
              <%= @need.age %>
            </p>
          <% end %>

          <% if @need.gender %>
            <p class="gender">
              <strong>Gender: </strong>
              <%= @need.gender %>
            </p>
          <% end %>
        </div>
      <% end %>

      <% if current_user == @need.user_church_admin %>
        <div class="private-records-block">
          <div class="previous-records-bar">
            <span class="record-count">

              <span class="record-count" data-toggle="modal" data-target="#rosmModal">0 Previous Records for <%= @need.first_name %> <%=  @need.last_name %></span>

              
            </span>
            <span class="details">Show Results</span>
          </div>
<!--           <div class="potential-benefits-bar">
            <span class="record-count">
              0 Potential Benefits Available
            </span>
            <span class="details">Show Results</span>
          </div>
 -->        </div>
      <% end %>

      <% @need.updates.each do |update| %>
        <div class="public-update-bar">
          <span class="record-count" data-toggle="modal" data-target="#PublicUpdateModal<%= update.id%>"><%= update.title %></span>
<!--           This should only show up for the right people 
 -->          
          <span class="details"><%= link_to "Edit", edit_need_update_path(@need, update) %></span>
        </div>
      <% end %>

      <%= link_to "New Update", new_need_update_path(@need) %>
      <div class="row need-details">
        <div class="expenses col-xs-12 col-sm-6">
          <h3>Expenses</h3>
          <div class="expenses-bar">
            <span class="progress-bar" style="width:<%= @need.percent_raised %>%"></span>
            <span class="amount-raised"><%= humanized_money_with_symbol @need.total_contributed %> / <%= humanized_money_with_symbol @need.total_expenses %></span>
          </div>
        </div>
        <div class="skills col-xs-12 col-sm-6">
          <h3>Skills needed</h3>
          <div class="skills-bar">
            <span class="progress-bar"></span>
            <span class="skills-count"><%= @need.skills_count %> 
            <% if @need.skills_count == 1 %>
              Skill
            <% else %>
              Skills
            <% end %>
            </span>
          </div>
          <% @need.skills.each do |skill| %>
            <p>
              <img src=<%= skill.icon_url%> style="background-color:grey;"> <%= skill.name %>
            </p>
          <% end %>
        </div>
      </div>

      <div class="map-location">
          <script>
            var map_hash = <%= raw @hash.to_json %>;
          </script>
          <%= render 'layouts/small_map' %>
      </div>

      <div class="row responsibility-bar">
        <% if current_user == @need.user_posted_by || current_user == @need.user_church_admin %>
          <div class="responsible-user col-xs-4">
            <div class="user-title">
              <h3>Posted By</h3>
            </div>

            <% if !@need.user_posted_by.avatar_file_name.nil? %>
              <div class="user-image">
                <%= image_tag(@need.user_posted_by.avatar, class: "img-circle") %>
              </div>
            <% else %>
              <div class="placeholder-leader-image"></div>
            <% end %>

            <div class="user-details">
              <%= @need.user_posted_by.full_name %>
            </div>
          </div>
        <% end %>

        <div class="responsible-user col-xs-4">
          <div class="user-title">
            <h3>Admin</h3>
          </div>

            <% if !@need.user_church_admin.avatar_file_name.nil? %>
              <div class="user-image">
                <%= image_tag(@need.user_church_admin.avatar, class: "img-circle") %>
              </div>
            <% else %>
              <div class="placeholder-leader-image"></div>
            <% end %>



          <div class="user-details">
            <%= @need.user_church_admin.full_name %>
          </div>
        </div>

        <div class="responsible-user col-xs-4">
          <div class="user-title">
            <h3>Leader</h3>
          </div>
          <div class="user-image">
            <div class="placeholder-leader-image"></div>
            <div class="user-details">
              <p class="unsupported-feature">This feature is not yet supported yet.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% if can? :update, @need %>
      <%= link_to 'Edit Need', edit_need_path(@need), :class => "full-width-btn" %>
    <% end %>
      <%= link_to 'Contribute', new_need_contribution_path(@need), :class => "full-width-btn-green" %>
  </div>

<!--   <form url= <%needs_create_charge_path%> method="POST" id="payment-form">
  <span class="payment-errors"></span>

  <div class="form-row">
    <label>
      <span>Card Number</span>
      <input type="text" size="20" data-stripe="number"/>
    </label>
  </div>

  <div class="form-row">
    <label>
      <span>CVC</span>
      <input type="text" size="4" data-stripe="cvc"/>
    </label>
  </div>

  <div class="form-row">
    <label>
      <span>Expiration (MM/YYYY)</span>
      <input type="text" size="2" data-stripe="exp-month"/>
    </label>
    <span> / </span>
    <input type="text" size="4" data-stripe="exp-year"/>
  </div>

  <button type="submit">Submit Payment</button>
</form>
 -->
 
</div>

<!-- expensesModal -->
<div class="modal fade" id="expensesModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Expenses</h4>
      </div>
      <div class="modal-body">
        <% @need.expenses.each do |expense| %>
          <p>
            <%= expense.title %> | 
            <%= expense.description %> | 
            <%= expense.documentation %> |
            <%= humanized_money_with_symbol expense.amount %>
            <%= link_to "Edit", edit_need_expense_path(@need, expense), :class => 'important-btn' %> | 
            <%= link_to "Delete", [@need, expense], method: :delete, data: { confirm: "Are you sure you want to delete this status?"} %>
          </p>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#NewExpenseModal">Add Expense</span>
      </div>
    </div>
  </div>
</div>

<!-- NewExpenseModal -->
<div class="modal fade" id="NewExpenseModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Expenses</h4>
      </div>
      <div class="modal-body">
        <%= render 'expenses/form' %>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>

<!-- skillsModal -->
<div class="modal fade" id="skillsModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Skills</h4>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- rosmModal -->
<div class="modal fade" id="rosmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">ROSM Records</h4>
      </div>
      <div class="modal-body">
        <p>
Jun 18th 2012 $180 Rent Assistance - Client came to us to ask and we helped.
</p>
<p>
May 11th 2014 $130 Utilities Assistance - Client came to us to ask and we helped.
</p>
<p>
Jan 18th 2014 $180 Rent Assistance - Client came to us to ask and we helped.
</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- PublicUpdateModal -->



      <% @need.updates.each do |update| %>

<div class="modal fade" id="PublicUpdateModal<%= update.id%>" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel"><%= @need.updates.first.title %></h4>
      </div>
      <div class="modal-body">
<!--         This only shows the first...
 -->        
        <%= update.content %>

        <br>
        <br>
        <% update.images.each do |image| %>
          <%= image_tag(image.image) %>
          <br>
          <%= image.caption %>
          <br>
          <br>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
      <% end %>



